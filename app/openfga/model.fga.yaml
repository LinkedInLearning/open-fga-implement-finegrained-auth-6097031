model: |
  model 
  schema 1.1

  type user

  type organization
    relations
      define admin: [user]
      define member: [user]
      define viewer: [user]

      define can_add_member: admin
      define can_delete_member: admin
      define can_view_member: admin or member
      define can_add_document: admin or member

  type document
    relations
      define organization: [organization]
      
      # Roles específicos del documento
      define owner: [user]
      define editor: [user]
      define viewer: [user, user:*, user with temporal_access]

      # Permisos que combinan roles organizacionales Y específicos del documento
      define can_read: owner or editor or viewer or admin from organization or member from organization or viewer from organization
      define can_write: editor or owner or admin from organization
      define can_delete: owner or admin from organization

  condition temporal_access(grant_time: timestamp, grant_duration: duration, current_time: timestamp) {
     current_time < grant_time + grant_duration
  }

tuples:
  - user: user:alice
    relation: admin
    object: organization:tech-company
  - user: user:charlie
    relation: viewer
    object: organization:tech-company
  - user: user:diana
    relation: member
    object: organization:marketing-dept
  - user: organization:tech-company
    relation: organization
    object: document:technical-specs
  - user: organization:tech-company
    relation: organization
    object: document:company-handbook
  - user: organization:marketing-dept
    relation: organization
    object: document:marketing-plan
  - user: user:alice
    relation: owner
    object: document:personal-notes
  - user: organization:tech-company
    relation: organization
    object: document:personal-notes
  - user: user:bob
    relation: owner
    object: document:project-plan
  - user: user:charlie
    relation: editor
    object: document:project-plan
  - user: user:alice
    relation: owner
    object: document:confidential-report
  - user: user:bob
    relation: viewer
    object: document:confidential-report
  - user: user:bob
    relation: owner
    object: document:company-handbook
  - user: user:charlie
    relation: viewer
    object: document:company-handbook
  - user: user:bob
    relation: viewer
    object: document:personal-notes
    condition: 
      name: temporal_access
      context: 
        grant_time : "2023-01-01T00:00:00Z"
        grant_duration : 1h
        current_time: "2023-01-01T00:10:00Z"

tests:
  - check:
    # Permisos por roles organizacionales:
    - user: user:alice
      object: document:company-handbook
      assertions:
        can_read: true
    - user: user:bob
      object: document:technical-specs
      assertions:
        can_write: false
        can_read: false # bob is not in the organization
    - user: user:charlie
      object: document:company-handbook
      assertions:
        can_write: false 
    - user: user:diana
      object: document:company-handbook
      assertions:
        can_read: false
    # Permisos por propiedad individual:
    - user: user:alice
      object: document:personal-notes
      assertions:
        can_read: true
        can_write: true
        can_delete: true
    - user: user:bob
      object: document:personal-notes
      assertions:
        can_write: false
    - user: user:charlie
      object: document:personal-notes
      assertions:
        can_read: true 
        can_write: false
    # Permisos organizacionales:
    - user: user:alice
      object: organization:tech-company
      assertions:
        can_add_member: true
    - user: user:bob
      object: organization:tech-company
      assertions:
        can_add_member: false
    - user: user:bob
      object: organization:tech-company
      assertions:
        can_view_member: false # not in the organization
    - user: user:bob
      object: document:project-plan
      assertions:
        owner: true
    - user: user:charlie
      object: document:project-plan
      assertions:
        editor: true
    - user: user:alice
      object: document:confidential-report
      assertions:
        owner: true
    - user: user:bob
      object: document:confidential-report
      assertions:
        viewer: true
    - user: user:bob
      object: document:company-handbook
      assertions:
        owner: true
    - user: user:charlie
      object: document:company-handbook
      assertions: 
        viewer: true
  - name: "Test temporal access for user:bob"
    check:
    - user: user:bob
      object: document:personal-notes
      assertions:
        viewer: true
