model: |
  model 
  schema 1.1

  type user

  type organization
    relations
      define admin: [user]
      define member: [user]
      # Eliminado: viewer (no se usaba correctamente)
      
      # Permisos organizacionales
      define can_add_member: admin
      define can_delete_member: admin
      define can_view_member: admin or member
      define can_manage_content: admin or member  # Nuevo: consolida permisos de contenido

  type folder
    relations
      define organization: [organization]
      define parent: [folder]  # Nuevo: soporte para jerarqu√≠a de carpetas
      define owner: [user]     # Nuevo: propietario de carpeta
      define editor: [user] or editor from parent
      define viewer: [user] or viewer from parent or editor
      
      # Permisos de carpeta (antes faltaban)
      define can_read: viewer or editor or owner or can_manage_content from organization
      define can_write: editor or owner or can_manage_content from organization
      define can_delete: owner or admin from organization

  type document
    relations
      define organization: [organization]
      define parent: [folder]
      define owner: [user]
      define viewer: [user, user:*, user with temporal_access] or viewer from parent

      # Permisos backwards compatibles
      define editor: [user] or editor from parent
      define writer: [user] or editor or editor from parent
      define can_write: writer or owner or can_manage_content from organization
      define can_edit: writer or owner or can_manage_content from organization
      
      define can_read: viewer or writer or owner or can_manage_content from organization
      define can_delete: owner or admin from organization

  condition temporal_access(grant_time: timestamp, grant_duration: duration, current_time: timestamp) {
    current_time < grant_time + grant_duration
  }

tuples:
  - user: user:alice
    relation: admin
    object: organization:tech-company
  - user: user:charlie
    relation: member
    object: organization:tech-company
  - user: user:diana
    relation: member
    object: organization:marketing-dept
  - user: organization:tech-company
    relation: organization
    object: document:technical-specs
  - user: organization:tech-company
    relation: organization
    object: document:company-handbook
  - user: organization:marketing-dept
    relation: organization
    object: document:marketing-plan
  - user: user:alice
    relation: owner
    object: document:personal-notes
  - user: organization:tech-company
    relation: organization
    object: document:personal-notes
  - user: user:bob
    relation: owner
    object: document:project-plan
  - user: user:charlie
    relation: editor
    object: document:project-plan
  - user: user:alice
    relation: owner
    object: document:confidential-report
  - user: user:bob
    relation: viewer
    object: document:confidential-report
  - user: user:bob
    relation: owner
    object: document:company-handbook
  - user: user:charlie
    relation: viewer
    object: document:company-handbook
  - user: user:bob
    relation: viewer
    object: document:personal-notes
    condition: 
      name: temporal_access
      context: 
        grant_time : "2023-01-01T00:00:00Z"
        grant_duration : 1h
        current_time: "2023-01-01T00:10:00Z"
  - user: user:alice
    relation: editor
    object: folder:project-files
  - user: folder:project-files
    relation: parent
    object: document:new-project-doc # alice tiene acceso a este documento porque es editor de la carpeta
  - user: user:carla
    relation: editor
    object: document:project-plan
  - user: user:chris
    relation: editor
    object: document:project-plan
# nuevas relaciones para el nuevo modelos
  - user: user:dasha
    relation: writer
    object: document:project-plan
  - user: user:felipe
    relation: writer
    object: document:project-plan

tests:
  - check:
    # Permisos por roles organizacionales:
    - user: user:alice
      object: document:company-handbook
      assertions:
        can_read: true
    - user: user:bob
      object: document:technical-specs
      assertions:
        can_write: false
        can_read: false # bob is not in the organization
    - user: user:charlie
      object: document:company-handbook
      assertions:
        can_write: true 
    - user: user:diana
      object: document:company-handbook
      assertions:
        can_read: false
    # Permisos por propiedad individual:
    - user: user:alice
      object: document:personal-notes
      assertions:
        can_read: true
        can_write: true
        can_delete: true
    - user: user:bob
      object: document:personal-notes
      assertions:
        can_write: false
    - user: user:charlie
      object: document:personal-notes
      assertions:
        can_read: true 
        can_write: true
    # Permisos organizacionales:
    - user: user:alice
      object: organization:tech-company
      assertions:
        can_add_member: true
    - user: user:bob
      object: organization:tech-company
      assertions:
        can_add_member: false
    - user: user:bob
      object: organization:tech-company
      assertions:
        can_view_member: false # not in the organization
    - user: user:bob
      object: document:project-plan
      assertions:
        owner: true
    - user: user:charlie
      object: document:project-plan
      assertions:
        editor: true
    - user: user:alice
      object: document:confidential-report
      assertions:
        owner: true
    - user: user:bob
      object: document:confidential-report
      assertions:
        viewer: true
    - user: user:bob
      object: document:company-handbook
      assertions:
        owner: true
    - user: user:charlie
      object: document:company-handbook
      assertions: 
        viewer: true
  - name: "Test temporal access for user:bob"
    check:
    - user: user:bob
      object: document:personal-notes
      assertions:
        viewer: true
  - name: "Test de acceso a traves de jerarquia"
    check:
    - user: user:alice
      object: document:new-project-doc
      assertions:
        can_read: true
        can_write: true
        can_delete: false
  - name: "Test de backwards compatible"
    check:
    - user: user:carla
      object: document:project-plan
      assertions:
        can_write: true
        can_edit: true
  - name: "Test de backwards compatible"
    check:
    - user: user:chris
      object: document:project-plan
      assertions:
        can_write: true
        can_edit: true
  - name: "Test de backwards compatible"
    check:
    - user: user:dasha
      object: document:project-plan
      assertions:
        can_write: true
        can_edit: true
